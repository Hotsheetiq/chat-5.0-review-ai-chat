<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Status Dashboard - Chris AI</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <meta http-equiv="refresh" content="30">
    <style>
        .status-card {
            background: var(--bs-dark);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .status-healthy {
            border-left: 4px solid #28a745;
        }
        .status-warning {
            border-left: 4px solid #ffc107;
        }
        .status-error {
            border-left: 4px solid #dc3545;
        }
        .status-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
        .metric {
            background: var(--bs-secondary);
            border-radius: 0.25rem;
            padding: 0.5rem;
            margin: 0.25rem 0;
        }
        .system-overview {
            background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
            color: white;
            border-radius: 0.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
    </style>
</head>
<body data-bs-theme="dark">
    <div class="container-fluid py-4">
        
        <!-- System Overview -->
        <div class="system-overview">
            <h1 class="mb-3">üî• Service Status Dashboard</h1>
            <p class="lead mb-2">Chris AI Property Management System</p>
            <div class="row text-center">
                <div class="col-md-3">
                    <h3>{{ status.system_status|title }}</h3>
                    <small>System Status</small>
                </div>
                <div class="col-md-3">
                    <h3>{{ status.services|length }}</h3>
                    <small>Services Monitored</small>
                </div>
                <div class="col-md-3">
                    {% set healthy_count = status.services.values() | selectattr('is_healthy') | list | length %}
                    <h3>{{ healthy_count }}/{{ status.services|length }}</h3>
                    <small>Services Healthy</small>
                </div>
                <div class="col-md-3">
                    <h3>{{ status.last_updated.strftime('%H:%M') if status.last_updated else 'Unknown' }}</h3>
                    <small>Last Updated</small>
                </div>
            </div>
        </div>

        <!-- Service Cards -->
        <div class="row">
            {% for service_name, service_data in status.services.items() %}
            <div class="col-lg-6 col-xl-3">
                <div class="status-card {% if service_data.is_healthy %}status-healthy{% elif service_data.needs_attention %}status-error{% else %}status-warning{% endif %}">
                    
                    <!-- Service Header -->
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-icon">
                            {% if service_data.is_healthy %}
                                ‚úÖ
                            {% elif service_data.needs_attention %}
                                ‚ùå
                            {% else %}
                                ‚ö†Ô∏è
                            {% endif %}
                        </span>
                        <div>
                            <h5 class="mb-1">
                                {% if service_name == 'grok_ai' %}
                                    Grok AI
                                {% elif service_name == 'elevenlabs' %}
                                    ElevenLabs Voice
                                {% elif service_name == 'twilio' %}
                                    Twilio Webhooks
                                {% elif service_name == 'rent_manager' %}
                                    Rent Manager API
                                {% endif %}
                            </h5>
                            <small class="text-muted">{{ service_name }}</small>
                        </div>
                    </div>

                    <!-- Service Metrics -->
                    <div class="metric">
                        <strong>Last Success:</strong><br>
                        <small>
                            {% if service_data.last_success %}
                                {{ service_data.last_success | strftime('%-m/%-d/%Y %-I:%M %p') }}
                            {% else %}
                                Never
                            {% endif %}
                        </small>
                    </div>

                    {% if service_data.success_rate is defined %}
                    <div class="metric">
                        <strong>Success Rate:</strong> {{ service_data.success_rate }}%
                    </div>
                    {% endif %}

                    {% if service_data.consecutive_failures > 0 %}
                    <div class="metric">
                        <strong>Consecutive Failures:</strong> 
                        <span class="text-warning">{{ service_data.consecutive_failures }}</span>
                    </div>
                    {% endif %}

                    {% if service_data.last_error %}
                    <div class="metric">
                        <strong>Last Error:</strong><br>
                        <small class="text-danger">{{ service_data.last_error[:100] }}{% if service_data.last_error|length > 100 %}...{% endif %}</small>
                    </div>
                    {% endif %}

                    <!-- Special fields for Rent Manager -->
                    {% if service_name == 'rent_manager' and service_data.token_refreshed %}
                    <div class="metric">
                        <strong>Token Refreshed:</strong><br>
                        <small class="text-info">{{ service_data.token_refreshed | strftime('%-m/%-d/%Y %-I:%M %p') }}</small>
                    </div>
                    {% endif %}

                    <!-- Status Badge -->
                    <div class="mt-3">
                        {% if service_data.is_healthy %}
                            <span class="badge bg-success">Healthy</span>
                        {% elif service_data.needs_attention %}
                            <span class="badge bg-danger">Needs Attention</span>
                        {% else %}
                            <span class="badge bg-warning">Warning</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Alert Section -->
        {% set alerts = status.services.values() | selectattr('needs_attention') | list %}
        {% if alerts %}
        <div class="alert alert-danger mt-4">
            <h5 class="alert-heading">üö® Services Requiring Attention</h5>
            <ul class="mb-0">
                {% for service_name, service_data in status.services.items() %}
                    {% if service_data.needs_attention %}
                    <li>
                        <strong>{{ service_name|title }}:</strong> 
                        {{ service_data.consecutive_failures }} consecutive failures
                        {% if service_data.last_error %}
                        - {{ service_data.last_error[:150] }}
                        {% endif %}
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Navigation -->
        <div class="text-center mt-4 mb-3">
            <a href="/" class="btn btn-primary me-2">‚Üê Back to Dashboard</a>
            <button onclick="goToDashboard()" class="btn btn-outline-primary me-2">üè† JS Navigation</button>
            <button onclick="location.reload()" class="btn btn-secondary">üîÑ Refresh</button>
        </div>

        <!-- Footer -->
        <div class="text-center mt-4">
            <small class="text-muted">
                Dashboard auto-refreshes every 30 seconds | 
                Last updated: {{ status.last_updated.strftime('%-m/%-d/%Y %-I:%M %p EST') if status.last_updated else 'Unknown' }}
            </small>
        </div>

    </div>
    
    <script>
        function goToDashboard() {
            // Multiple navigation methods for maximum compatibility
            console.log('Navigating to dashboard...');
            
            // Method 1: Direct assignment
            try {
                window.location = '/';
                return;
            } catch (e) {
                console.log('Method 1 failed:', e);
            }
            
            // Method 2: href assignment
            try {
                window.location.href = '/';
                return;
            } catch (e) {
                console.log('Method 2 failed:', e);
            }
            
            // Method 3: replace method
            try {
                window.location.replace('/');
                return;
            } catch (e) {
                console.log('Method 3 failed:', e);
            }
            
            // Method 4: Create and click link
            try {
                const link = document.createElement('a');
                link.href = '/';
                link.click();
                return;
            } catch (e) {
                console.log('Method 4 failed:', e);
            }
            
            // Final fallback: Manual refresh
            console.error('All navigation methods failed');
            alert('Navigation failed. Please manually click your browser\'s back button or go to the main page.');
        }
    </script>
</body>
</html>