<!DOCTYPE html>
<html>
<head>
    <title>üìû Call History - Chris AI</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <meta http-equiv="refresh" content="60">
    <style>
        .call-card {
            border-left: 4px solid var(--bs-secondary);
            margin-bottom: 1rem;
        }
        .call-card.emergency {
            border-left-color: var(--bs-danger);
        }
        .call-card.maintenance {
            border-left-color: var(--bs-warning);
        }
        .call-card.inquiry {
            border-left-color: var(--bs-info);
        }
        .transcription-preview {
            max-height: 100px;
            overflow-y: auto;
            background-color: var(--bs-dark);
            border: 1px solid var(--bs-border-color);
            border-radius: 4px;
            padding: 8px;
            font-size: 0.9em;
        }
        .call-duration {
            font-family: monospace;
            background-color: var(--bs-secondary-bg-subtle);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .search-box {
            background-color: var(--bs-dark);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .status-badge {
            font-size: 0.75em;
            padding: 4px 8px;
        }
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        .call-stats {
            background-color: var(--bs-info-bg-subtle);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body data-bs-theme="dark">
    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìû Call History</h2>
            <div>
                <a href="/live-monitoring" class="btn btn-outline-info">üì° Live Monitoring</a>
                <a href="/" class="btn btn-outline-secondary ms-2">‚Üê Dashboard</a>
            </div>
        </div>

        <!-- Call Statistics -->
        <div class="call-stats">
            <div class="row">
                <div class="col-md-3">
                    <h4>{{ calls|length }}</h4>
                    <small>Filtered Results</small>
                </div>
                <div class="col-md-3">
                    <h4>{{ total_calls }}</h4>
                    <small>Total Calls</small>
                </div>
                <div class="col-md-3">
                    <h4>{{ calls|selectattr('issue_type')|list|length }}</h4>
                    <small>Service Requests</small>
                </div>
                <div class="col-md-3">
                    <h4>{{ moment().format('h:mm A') if moment else 'Now' }}</h4>
                    <small>Last Updated</small>
                </div>
            </div>
        </div>

        <!-- Search and Filter Box -->
        <div class="search-box">
            <form method="GET" class="row g-3">
                <div class="col-md-6">
                    <label for="search" class="form-label">Search Calls</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="{{ search_query }}" 
                           placeholder="Search by name, phone, issue type, or transcript...">
                </div>
                <div class="col-md-3">
                    <label for="date" class="form-label">Date Filter</label>
                    <input type="date" class="form-control" id="date" name="date" value="{{ search_date }}">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">üîç Search</button>
                    {% if search_query or search_date %}
                        <a href="/call-history" class="btn btn-outline-secondary">Clear</a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Call History List -->
        {% if calls %}
            <div class="row">
                {% for call in calls %}
                <div class="col-12 mb-3">
                    <div class="card call-card 
                        {% if call.issue_type and 'electrical' in call.issue_type.lower() or 'emergency' in call.issue_type.lower() %}emergency
                        {% elif call.issue_type %}maintenance
                        {% else %}inquiry{% endif %}">
                        <div class="card-body">
                            <div class="row">
                                <!-- Call Info Column -->
                                <div class="col-md-4">
                                    <h6 class="card-title">
                                        {% if call.caller_name %}
                                            {{ call.caller_name }}
                                        {% else %}
                                            Unknown Caller
                                        {% endif %}
                                        <span class="status-badge badge bg-{% if call.status == 'completed' %}success{% elif call.status == 'in-progress' %}primary{% else %}secondary{% endif %}">
                                            {{ call.status|title if call.status else 'Completed' }}
                                        </span>
                                    </h6>
                                    <p class="card-text">
                                        <strong>üìû Phone:</strong> {{ call.from_number }}<br>
                                        <strong>üïí Time:</strong> {{ call.timestamp.split('T')[0] if 'T' in call.timestamp else call.timestamp.split(' ')[0] }} 
                                        {{ call.timestamp.split('T')[1][:8] if 'T' in call.timestamp else call.timestamp.split(' ')[1][:8] if ' ' in call.timestamp else '' }}<br>
                                        <strong>‚è±Ô∏è Duration:</strong> 
                                        <span class="call-duration">{{ call.duration if call.duration else 'N/A' }}</span><br>
                                        {% if call.issue_type %}
                                            <strong>üîß Issue:</strong> {{ call.issue_type }}<br>
                                        {% endif %}
                                        {% if call.service_ticket_number %}
                                            <strong>üé´ Ticket:</strong> {{ call.service_ticket_number }}<br>
                                        {% endif %}
                                        <strong>üìã Call ID:</strong> <code>{{ call.call_sid[:8] }}...</code>
                                    </p>
                                </div>

                                <!-- Transcription Column -->
                                <div class="col-md-6">
                                    <h6>üìù Conversation Transcript</h6>
                                    {% if call.transcription and call.transcription|length > 0 %}
                                        <div class="transcription-preview">
                                            {% for segment in call.transcription[:5] %}
                                                <div class="mb-1">
                                                    <strong>{{ 'Caller' if segment.speaker == 'caller' else 'Chris' }}:</strong> 
                                                    {{ segment.text }}
                                                </div>
                                            {% endfor %}
                                            {% if call.transcription|length > 5 %}
                                                <div class="text-muted"><em>... {{ call.transcription|length - 5 }} more messages</em></div>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div class="text-muted">No transcription available</div>
                                    {% endif %}
                                </div>

                                <!-- Actions Column -->
                                <div class="col-md-2">
                                    <h6>Actions</h6>
                                    <div class="d-grid gap-2">
                                        <a href="/call-details/{{ call.call_sid }}" class="btn btn-sm btn-outline-primary">
                                            üìã Details
                                        </a>
                                        {% if call.recording_url %}
                                            <audio controls class="w-100 mt-2" style="max-width: 200px;">
                                                <source src="{{ call.recording_url }}" type="audio/mpeg">
                                                Your browser does not support audio playback.
                                            </audio>
                                            <a href="{{ call.recording_url }}" class="btn btn-sm btn-outline-success" download>
                                                ‚¨áÔ∏è Download
                                            </a>
                                        {% else %}
                                            <small class="text-muted">No recording</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info text-center">
                <h4>üì≠ No Calls Found</h4>
                <p>{% if search_query or search_date %}
                    No calls match your search criteria. <a href="/call-history">Clear filters</a> to see all calls.
                {% else %}
                    No call history available yet. Calls will appear here once Chris starts receiving them.
                {% endif %}</p>
            </div>
        {% endif %}

        <!-- Footer with Auto-refresh Info -->
        <div class="mt-4 text-center text-muted">
            <small>Page automatically refreshes every 60 seconds ‚Ä¢ Last updated: {{ moment().format('h:mm:ss A') if moment else 'Now' }}</small>
        </div>
    </div>

    <script>
        // Auto-refresh active calls every 30 seconds for live data
        setTimeout(() => {
            if (!document.hidden) {
                window.location.reload();
            }
        }, 30000);
        
        // Handle browser visibility to pause refresh when not active
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page hidden - pausing auto-refresh');
            } else {
                console.log('Page visible - resuming auto-refresh');
            }
        });
    </script>
</body>
</html>