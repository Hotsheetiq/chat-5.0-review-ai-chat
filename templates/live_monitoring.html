<!DOCTYPE html>
<html>
<head>
    <title>üìû Live Call Monitoring Dashboard</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <style>
        .call-card { border-left: 4px solid var(--bs-success); }
        .call-card.in-progress { border-left-color: var(--bs-primary); }
        .call-card.completed { border-left-color: var(--bs-secondary); }
        .transcription-box {
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--bs-dark);
            border: 1px solid var(--bs-border-color);
            border-radius: 4px;
            padding: 10px;
        }
        .transcript-line {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        .transcript-caller {
            background-color: var(--bs-primary-bg-subtle);
            border-left: 3px solid var(--bs-primary);
        }
        .transcript-chris {
            background-color: var(--bs-success-bg-subtle);
            border-left: 3px solid var(--bs-success);
        }
        .call-stats {
            background-color: var(--bs-info-bg-subtle);
            border-radius: 8px;
            padding: 15px;
        }
        .recording-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .live-indicator {
            background-color: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body data-bs-theme="dark">
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>üìû Live Call Monitoring Dashboard</h2>
                    <div class="d-flex gap-2">
                        <span class="live-indicator" id="live-status">LIVE</span>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()">
                            üîÑ Refresh
                        </button>
                        <a href="/?cache=false" class="btn btn-outline-secondary btn-sm">‚Üê Dashboard</a>
                        <button class="btn btn-outline-primary btn-sm" onclick="window.location.href = '/?t=' + Date.now()">üè† Fresh Load</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Calls Section -->
        <div class="row mb-4">
            <div class="col-12">
                <h4>üî¥ Active Calls (<span id="active-count">0</span>)</h4>
                <div id="active-calls" class="row">
                    <!-- Active calls will be populated here -->
                </div>
            </div>
        </div>

        <!-- Call History Section -->
        <div class="row">
            <div class="col-12">
                <h4>üìã Recent Call History</h4>
                <div class="d-flex gap-2 mb-3">
                    <input type="text" class="form-control" id="search-input" placeholder="Search calls by name, phone, or issue type...">
                    <button class="btn btn-primary" onclick="searchCalls()">Search</button>
                    <button class="btn btn-outline-secondary" onclick="clearSearch()">Clear</button>
                </div>
                <div id="call-history" class="row">
                    <!-- Call history will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;
        
        function startLiveUpdates() {
            refreshDashboard();
            refreshInterval = setInterval(refreshDashboard, 5000); // Update every 5 seconds
        }
        
        function stopLiveUpdates() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        function refreshDashboard() {
            fetch('/api/calls/active')
                .then(response => response.json())
                .then(data => updateActiveCalls(data))
                .catch(err => console.error('Error fetching active calls:', err));
                
            fetch('/api/calls/history')
                .then(response => response.json())
                .then(data => updateCallHistory(data))
                .catch(err => console.error('Error fetching call history:', err));
        }
        
        function updateActiveCalls(calls) {
            const container = document.getElementById('active-calls');
            const countElement = document.getElementById('active-count');
            
            countElement.textContent = calls.length;
            
            if (calls.length === 0) {
                container.innerHTML = '<p class="text-muted">No active calls</p>';
                return;
            }
            
            container.innerHTML = calls.map(call => `
                <div class="col-lg-6 mb-3">
                    <div class="card call-card in-progress">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">üìû ${call.from_number}</h6>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="live-indicator">LIVE</span>
                                <small class="text-muted">${formatDuration(call.duration)}s</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Caller:</strong> ${call.caller_name || 'Unknown'}
                                </div>
                                <div class="col-6">
                                    <strong>Issue:</strong> ${call.issue_type || 'Not specified'}
                                </div>
                            </div>
                            
                            <div class="transcription-box" id="transcription-${call.call_sid}">
                                ${renderTranscription(call.transcription)}
                            </div>
                            
                            <div class="mt-2 d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewCallDetails('${call.call_sid}')">
                                    View Details
                                </button>
                                <span class="text-muted">Started: ${formatTime(call.start_time)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateCallHistory(calls) {
            const container = document.getElementById('call-history');
            
            if (calls.length === 0) {
                container.innerHTML = '<p class="text-muted">No recent calls</p>';
                return;
            }
            
            container.innerHTML = calls.map(call => `
                <div class="col-lg-4 mb-3">
                    <div class="card call-card completed">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">üìû ${call.from_number}</h6>
                            <small class="text-muted">${formatDuration(call.duration)}s</small>
                        </div>
                        <div class="card-body">
                            <p><strong>Caller:</strong> ${call.caller_name || 'Unknown'}</p>
                            <p><strong>Issue:</strong> ${call.issue_type || 'General inquiry'}</p>
                            <p><strong>Status:</strong> <span class="badge bg-success">${call.status}</span></p>
                            
                            <div class="recording-controls">
                                ${call.recording_url ? 
                                    `<audio controls class="flex-grow-1">
                                        <source src="${call.recording_url}" type="audio/mpeg">
                                        Your browser does not support audio playback.
                                    </audio>` : 
                                    '<span class="text-muted">No recording available</span>'
                                }
                            </div>
                            
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewCallDetails('${call.call_sid}')">
                                    View Transcript
                                </button>
                                <small class="text-muted float-end">${formatTime(call.start_time)}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderTranscription(transcription) {
            if (!transcription || transcription.length === 0) {
                return '<p class="text-muted">No transcription available</p>';
            }
            
            return transcription.map(segment => `
                <div class="transcript-line transcript-${segment.speaker}">
                    <strong>${segment.speaker === 'caller' ? 'Caller' : 'Chris'}:</strong>
                    ${segment.text}
                    <small class="text-muted float-end">${formatTime(segment.timestamp)}</small>
                </div>
            `).join('');
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : secs.toString();
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleString('en-US', {
                month: 'numeric',
                day: 'numeric', 
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZoneName: 'short'
            });
        }
        
        function viewCallDetails(callSid) {
            // Open modal or navigate to detailed view
            window.open(`/call-details/${callSid}`, '_blank');
        }
        
        function searchCalls() {
            const query = document.getElementById('search-input').value;
            fetch(`/api/calls/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => updateCallHistory(data))
                .catch(err => console.error('Error searching calls:', err));
        }
        
        function clearSearch() {
            document.getElementById('search-input').value = '';
            refreshDashboard();
        }
        
        function goToDashboard() {
            // Multiple navigation methods for maximum compatibility
            console.log('Navigating to dashboard...');
            
            // Method 1: Direct assignment
            try {
                window.location = '/';
                return;
            } catch (e) {
                console.log('Method 1 failed:', e);
            }
            
            // Method 2: href assignment
            try {
                window.location.href = '/';
                return;
            } catch (e) {
                console.log('Method 2 failed:', e);
            }
            
            // Method 3: replace method
            try {
                window.location.replace('/');
                return;
            } catch (e) {
                console.log('Method 3 failed:', e);
            }
            
            // Method 4: Create and click link
            try {
                const link = document.createElement('a');
                link.href = '/';
                link.click();
                return;
            } catch (e) {
                console.log('Method 4 failed:', e);
            }
            
            // Final fallback: Manual refresh
            console.error('All navigation methods failed');
            alert('Navigation failed. Please manually click your browser\'s back button or go to the main page.');
        }
        
        // Start live updates when page loads
        document.addEventListener('DOMContentLoaded', startLiveUpdates);
        
        // Stop updates when page is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopLiveUpdates();
            } else {
                startLiveUpdates();
            }
        });
    </script>
</body>
</html>